'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { FileCheck } from 'lucide-react';

// --- CONFIGURACIÓN DE ESTILO ---
const THEME = {
  bg: 'bg-black',
  textMain: 'text-white',
  textMuted: 'text-[#94A3B8]',
  gold: 'text-[#FFD700]',
  titanium: 'text-[#94A3B8]',
};

// --- BASE PATH PARA IMÁGENES ---
const IMG_PATH = '/images/presentaciones/cierre';

// --- TIPOS ---
interface SlideBase {
  id: number;
  type: string;
  note?: string;
}

interface BlackSlide extends SlideBase {
  type: 'black';
}

interface SpinnerSlide extends SlideBase {
  type: 'spinner';
  title: string;
  image?: string;
}

interface HeroSlide extends SlideBase {
  type: 'hero';
  title: string;
  sub?: string;
  image?: string;
  color: 'gold' | 'titanium' | 'white';
}

interface TitleSlide extends SlideBase {
  type: 'title' | 'big-text' | 'final';
  content: string;
  sub?: string;
  color?: 'gold' | 'white' | 'muted';
}

interface ChartSlide extends SlideBase {
  type: 'chart';
  title: string;
  sub: string;
  image?: string;
  color?: 'gold' | 'white';
}

interface CollageSlide extends SlideBase {
  type: 'collage';
  title: string;
  sub: string;
  images: string[];
}

interface ImageTextSlide extends SlideBase {
  type: 'image-text';
  title: string;
  sub: string;
  image: string;
  overlay?: boolean;
}

type Slide = BlackSlide | SpinnerSlide | HeroSlide | TitleSlide | ChartSlide | CollageSlide | ImageTextSlide;

// --- DATA DE DIAPOSITIVAS (SECUENCIA NARRATIVA CORREGIDA v10.1) ---
const SLIDES: Slide[] = [
  // ========================================
  // BLOQUE 1: EL VILLANO & LA DEPENDENCIA (0-2)
  // ========================================
  {
    id: 0,
    type: 'black',
    note: 'Inicio en silencio - Gancho emocional'
  },
  {
    id: 1,
    type: 'spinner',
    title: 'PLAN POR DEFECTO',
    image: `${IMG_PATH}/plan-por-defecto.jpg`,
    note: 'El ciclo infinito: Trabajar > Pagar > Repetir'
  },
  {
    id: 2,
    type: 'hero',
    title: 'DEPENDENCIA',
    image: `${IMG_PATH}/dependencia-2.jpg`,
    color: 'white',
    note: 'Falla Frágil: Si paras, ganas cero.'
  },

  // ========================================
  // BLOQUE 2: EL CONTEXTO - La Transición (3)
  // ========================================
  {
    id: 3,
    type: 'image-text',
    title: 'CAMBIO DE ERA',
    sub: 'EL MAPA HA CAMBIADO',
    image: `${IMG_PATH}/fracture.jpg`,
    overlay: true,
    note: 'Contexto: La vieja estabilidad se rompió.'
  },

  // ========================================
  // BLOQUE 3: LAS OSCILACIONES - El Dolor (4-9)
  // ========================================

  // TIEMPO
  {
    id: 4,
    type: 'hero',
    title: 'INGRESO MANUAL',
    image: `${IMG_PATH}/el-problema.jpg`,
    color: 'titanium',
  },
  {
    id: 5,
    type: 'hero',
    title: 'FLUJO PERPETUO',
    image: `${IMG_PATH}/la-solucion.jpg`,
    color: 'gold',
  },

  // ESFUERZO
  {
    id: 6,
    type: 'hero',
    title: 'DESGASTE TÉRMICO',
    image: `${IMG_PATH}/esfuerzo.jpg`,
    color: 'titanium',
  },
  {
    id: 7,
    type: 'hero',
    title: 'CONTROL HIDRÁULICO',
    image: `${IMG_PATH}/el-valor-fluye.jpg`,
    color: 'gold',
  },

  // SEGURIDAD
  {
    id: 8,
    type: 'hero',
    title: 'FALLA FRÁGIL',
    image: `${IMG_PATH}/jaula-de-cristal.jpg`,
    color: 'titanium',
  },
  {
    id: 9,
    type: 'hero',
    title: 'RED ANTIFRÁGIL',
    image: `${IMG_PATH}/a-prueba-de-golpes.jpg`,
    color: 'gold',
  },

  // ========================================
  // BLOQUE 4: LA REVELACIÓN - El Clímax (10)
  // ========================================
  // SLIDE 10: LA TRÍADA DE CONVERGENCIA
  {
    id: 10,
    type: 'image-text',
    title: 'CONVERGENCIA',
    sub: 'CAPITAL + LOGÍSTICA + SISTEMA',
    image: `${IMG_PATH}/hybrid-core.jpg`,
    overlay: true,
    note: 'El Momento iPhone: Capital, Logística y Sistema Educativo'
  },

  // ========================================
  // BLOQUE 5: LA CERTEZA - Lógica (11-12)
  // ========================================
  {
    id: 11,
    type: 'big-text',
    content: 'CERTEZA',
    sub: 'NO MIEDO. LÓGICA.',
    color: 'white'
  },
  {
    id: 12,
    type: 'chart',
    title: '2.5 AÑOS',
    sub: 'EL MÉTODO',
    image: `${IMG_PATH}/gantt-chart.jpg`,
    color: 'gold'
  },

  // ========================================
  // BLOQUE 6: LA EVIDENCIA (13-14)
  // ========================================
  {
    id: 13,
    type: 'image-text',
    title: 'LA VISIÓN',
    sub: 'REALIDAD MATERIALIZADA',
    image: `${IMG_PATH}/tu-vista.jpg`,
    overlay: true
  },
  {
    id: 14,
    type: 'image-text',
    title: 'LOS PLANOS',
    sub: 'EXPANSIÓN CONTINENTAL',
    image: `${IMG_PATH}/blueprints.jpg`,
    overlay: true
  },

  // ========================================
  // BLOQUE 7: EL CIERRE (15-16)
  // ========================================
  {
    id: 15,
    type: 'image-text',
    title: 'AUDITORÍA',
    sub: '¿REPETIR O RECONSTRUIR?',
    image: `${IMG_PATH}/calendar-audit.jpg`,
    overlay: true,
    note: 'El costo de no actuar'
  },
  {
    id: 16,
    type: 'final',
    content: 'DECIDE',
    sub: 'SOBERANÍA O DEPENDENCIA',
    color: 'gold'
  }
];

// --- COMPONENTE PRINCIPAL ---
export default function PresentacionCierre() {
  const [currentSlide, setCurrentSlide] = useState(0);

  // Navegación con Teclado
  const handleNavigation = useCallback((direction: 'next' | 'prev') => {
    if (direction === 'next') {
      setCurrentSlide(prev => Math.min(prev + 1, SLIDES.length - 1));
    } else {
      setCurrentSlide(prev => Math.max(prev - 1, 0));
    }
  }, []);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'PageDown') {
        e.preventDefault();
        handleNavigation('next');
      } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
        e.preventDefault();
        handleNavigation('prev');
      } else if (e.key === 'Home') {
        e.preventDefault();
        setCurrentSlide(0);
      } else if (e.key === 'End') {
        e.preventDefault();
        setCurrentSlide(SLIDES.length - 1);
      } else if (e.key === 'f' || e.key === 'F') {
        toggleFullscreen();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [handleNavigation]);

  // Toggle Fullscreen
  const toggleFullscreen = () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  };

  // Click para avanzar
  const handleClick = (e: React.MouseEvent) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const isLeftSide = x < rect.width / 2;

    if (isLeftSide) {
      handleNavigation('prev');
    } else {
      handleNavigation('next');
    }
  };

  const slide = SLIDES[currentSlide];

  // Helpers de estilo
  const getTextColor = (color?: string) => {
    switch (color) {
      case 'gold': return 'text-[#FFD700]';
      case 'titanium': return 'text-[#94A3B8]';
      case 'muted': return 'text-[#94A3B8]';
      default: return 'text-white';
    }
  };

  const getTextShadow = (color?: string) => {
    if (color === 'gold') {
      return { textShadow: '0 0 20px rgba(255, 215, 0, 0.5)' };
    }
    return {};
  };

  // RENDERIZADO DE CONTENIDO
  const renderContent = () => {
    switch (slide.type) {
      case 'black':
        return <div className="w-full h-full bg-black" />;

      case 'spinner': {
        const s = slide as SpinnerSlide;
        return (
          <div className="relative w-full h-full flex items-center justify-center">
            {s.image && (
              <div
                className="absolute inset-0 bg-cover bg-center bg-no-repeat"
                style={{ backgroundImage: `url(${s.image})`, filter: 'brightness(0.4)' }}
              />
            )}
            <div className="relative z-10 flex flex-col items-center justify-center text-center space-y-8 px-8">
              <div className="w-32 h-32 border-8 border-gray-600 rounded-full border-t-transparent animate-spin" />
              <h1 className="text-6xl md:text-8xl lg:text-9xl font-black text-gray-500 uppercase tracking-tighter">
                {s.title}
              </h1>
            </div>
          </div>
        );
      }

      case 'hero': {
        const s = slide as HeroSlide;
        return (
          <div className="relative w-full h-full flex items-center justify-center">
            {s.image && (
              <div
                className="absolute inset-0 bg-cover bg-center bg-no-repeat"
                style={{ backgroundImage: `url(${s.image})`, filter: 'brightness(0.6)' }}
              />
            )}
            <div className="relative z-10 text-center px-8">
              <h1
                className={`text-6xl md:text-8xl lg:text-9xl font-black uppercase tracking-tighter ${getTextColor(s.color)}`}
                style={getTextShadow(s.color)}
              >
                {s.title}
              </h1>
              {s.sub && (
                <p className="text-xl md:text-3xl font-bold tracking-widest mt-6 uppercase text-[#FFD700]"
                   style={{ textShadow: '0 0 20px rgba(255, 215, 0, 0.5)' }}>
                  {s.sub}
                </p>
              )}
            </div>
          </div>
        );
      }

      case 'title':
      case 'big-text':
      case 'final': {
        const s = slide as TitleSlide;
        return (
          <div className="flex flex-col items-center justify-center h-full text-center space-y-6 px-8">
            <h1
              className={`text-6xl md:text-8xl lg:text-9xl font-black tracking-tighter ${getTextColor(s.color)}`}
              style={getTextShadow(s.color)}
            >
              {s.content}
            </h1>
            {s.sub && (
              <p className="text-xl md:text-2xl lg:text-3xl font-light tracking-[0.2em] text-[#94A3B8]">
                {s.sub}
              </p>
            )}
          </div>
        );
      }

      case 'chart': {
        const s = slide as ChartSlide;
        return (
          <div className="relative w-full h-full flex items-center justify-center">
             {/* Fondo de imagen para Chart (Gantt) */}
             {s.image && (
              <div
                className="absolute inset-0 bg-cover bg-center bg-no-repeat"
                style={{ backgroundImage: `url(${s.image})`, filter: 'brightness(0.5)' }}
              />
            )}
            <div className="relative z-10 flex flex-col items-center justify-center h-full px-8">
              {/* Icono técnico */}
              <FileCheck size={100} className="text-[#FFD700] mb-6 md:mb-10" strokeWidth={1} />
              <h1
                className="text-6xl md:text-8xl lg:text-9xl font-black text-white uppercase tracking-tighter"
                style={{ textShadow: '0 0 30px rgba(255, 215, 0, 0.3)' }}
              >
                {s.title}
              </h1>
              <p className="text-xl md:text-3xl text-[#94A3B8] mt-6 uppercase tracking-[0.3em] font-light">
                {s.sub}
              </p>
            </div>
          </div>
        );
      }

      case 'collage': {
        const s = slide as CollageSlide;
        return (
          <div className="relative w-full h-full flex flex-col">
            <div className="absolute inset-0 grid grid-cols-2 grid-rows-2">
              {s.images.map((img, idx) => (
                <div key={idx} className="relative overflow-hidden">
                  <div
                    className="absolute inset-0 bg-cover bg-center"
                    style={{ backgroundImage: `url(${img})` }}
                  />
                  <div className="absolute inset-0 bg-black/40" />
                </div>
              ))}
            </div>
            <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-black/60 z-10" />
            <div className="relative z-20 flex flex-col items-center justify-center h-full text-center p-10">
              <h1 className="text-6xl md:text-8xl lg:text-9xl font-black mb-6 text-[#FFD700] drop-shadow-2xl uppercase tracking-tighter"
                  style={{ textShadow: '0 0 20px rgba(255, 215, 0, 0.5)' }}>
                {s.title}
              </h1>
              <p className="text-xl md:text-3xl text-white tracking-[0.2em] uppercase drop-shadow-lg">
                {s.sub}
              </p>
            </div>
          </div>
        );
      }

      case 'image-text': {
        const s = slide as ImageTextSlide;
        return (
          <div className="relative w-full h-full flex items-center justify-center">
            <div
              className="absolute inset-0 bg-cover bg-center bg-no-repeat"
              style={{ backgroundImage: `url(${s.image})` }}
            />
            {s.overlay && <div className="absolute inset-0 bg-black/60 z-10" />}
            <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/40 z-10" />
            <div className="relative z-20 text-center p-10">
              {/* TIPOGRAFÍA UNIFICADA CON HERO Y TITLE */}
              <h1 className="text-6xl md:text-8xl lg:text-9xl font-black mb-6 text-[#FFD700] drop-shadow-2xl uppercase tracking-tighter"
                  style={{ textShadow: '0 0 20px rgba(255, 215, 0, 0.5)' }}>
                {s.title}
              </h1>
              <p className="text-xl md:text-3xl text-white tracking-[0.2em] uppercase drop-shadow-lg font-bold">
                {s.sub}
              </p>
            </div>
          </div>
        );
      }

      default:
        return null;
    }
  };

  return (
    <div
      className={`w-full h-screen ${THEME.bg} overflow-hidden relative select-none`}
      onClick={handleClick}
      style={{ cursor: 'none' }}
    >
      <AnimatePresence mode="wait">
        <motion.div
          key={currentSlide}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.8, ease: [0.4, 0, 0.2, 1] }}
          className="w-full h-full flex items-center justify-center"
        >
          {renderContent()}
        </motion.div>
      </AnimatePresence>

      <motion.div
        className="absolute bottom-0 left-0 h-1 bg-[#FFD700]"
        initial={{ width: 0 }}
        animate={{ width: `${((currentSlide + 1) / SLIDES.length) * 100}%` }}
        transition={{ duration: 0.5 }}
      />

      <div className="absolute bottom-4 right-6 text-gray-700 text-xs font-mono">
        {currentSlide} / {SLIDES.length - 1}
      </div>
    </div>
  );
}
